<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Texture Porter GD!</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <style>
    :root {
      --music-pink: #ff2d55;
      --bg-overlay: rgba(242, 242, 247, 0.25);
      --glass: rgba(255, 255, 255, 0.45);
      --border: rgba(255, 255, 255, 0.5);
      --text: #000000;
      --sub-text: rgba(0, 0, 0, 0.6);
    }
    body.dark-mode {
      --bg-overlay: rgba(0, 0, 0, 0.4);
      --glass: rgba(28, 28, 30, 0.5);
      --border: rgba(255, 255, 255, 0.15);
      --text: #ffffff;
      --sub-text: rgba(255, 255, 255, 0.5);
    }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; 
      margin: 0; padding: 0; min-height: 100vh;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: var(--text); overflow: hidden;
    }
    .custom-bg {
      position: fixed; top: -30px; left: -30px; right: -30px; bottom: -30px; 
      background-image: url('fondo.jpg'); background-size: cover;
      background-position: center; filter: blur(10px); z-index: -2;
    }
    .bg-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--bg-overlay); z-index: -1; transition: background 0.5s ease;
    }
    .contenedor {
      background: var(--glass); backdrop-filter: blur(35px) saturate(180%);
      -webkit-backdrop-filter: blur(35px) saturate(180%);
      border: 1px solid var(--border); border-radius: 40px;
      padding: 35px 25px; width: 85%; max-width: 350px; text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    h1 { font-size: 28px; font-weight: 800; letter-spacing: -1.5px; margin: 0; }
    .drop-zone {
      background: rgba(128,128,128,0.05); border: 1px dashed var(--sub-text);
      border-radius: 30px; padding: 45px 20px; cursor: pointer; display: block; margin-top: 20px;
    }
    #status { font-size: 11px; color: var(--music-pink); margin-top: 20px; font-weight: 800; }
    #saveBtn {
      background: var(--music-pink); color: #ffffff; border: none; padding: 18px; border-radius: 24px; 
      width: 100%; font-weight: 800; margin-top: 20px; display: none; cursor: pointer;
    }
  </style>
</head>
<body id="mainBody">

<div class="custom-bg"></div>
<div class="bg-overlay"></div>

<div class="contenedor">
  <h1>Texture Porter GD!</h1>
  <label for="file" class="drop-zone">
    <span>Seleccionar archivos sueltos o ZIP</span>
  </label>
  <input type="file" id="file" style="display:none;" multiple>
  <div id="status">READY</div>
  <button id="saveBtn">DESCARGAR PACK FIX</button>
</div>

<script>
  const st = document.getElementById('status');
  const sv = document.getElementById('saveBtn');

  const processPlist = (txt) => {
    // 1. Forzar cambio de extensión interna de uhd a hd
    let result = txt.replace(/\-uhd\.png/gi, '-hd.png');
    // 2. Dividir coordenadas (Enteros puros)
    result = result.replace(/\{\s*([-+]?\d*\.?\d+)\s*,\s*([-+]?\d*\.?\d+)\s*\}/g, (match, x, y) => {
        return `{${Math.floor(Number(x) / 2)},${Math.floor(Number(y) / 2)}}`;
    });
    return result;
  };

  const resizeImage = (blob) => {
    return new Promise((resolve) => {
      const img = new Image();
      const url = URL.createObjectURL(blob);
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = Math.floor(img.width / 2);
        canvas.height = Math.floor(img.height / 2);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob((newBlob) => {
          URL.revokeObjectURL(url);
          resolve(newBlob);
        }, 'image/png');
      };
      img.src = url;
    });
  };

  document.getElementById('file').addEventListener('change', async function(e) {
    const files = e.target.files;
    const zipOut = new JSZip();
    st.innerText = "PROCESANDO...";

    for (let f of files) {
      if (f.name.endsWith('.zip')) {
        const zipIn = await JSZip.loadAsync(f);
        for (let path in zipIn.files) {
          const file = zipIn.files[path];
          if (file.dir || path.includes('__MACOSX')) continue;

          let newPath = path.replace(/\-uhd/gi, '-hd');
          if (path.endsWith('.png')) {
            const blob = await file.async("blob");
            const res = await resizeImage(blob);
            zipOut.file(newPath, res);
          } else if (path.endsWith('.plist')) {
            const txt = await file.async("string");
            zipOut.file(newPath, processPlist(txt));
          } else {
            zipOut.file(newPath, await file.async("blob"));
          }
        }
      } else {
        let newName = f.name.replace(/\-uhd/gi, '-hd');
        if (f.name.endsWith('.png')) {
          zipOut.file(newName, await resizeImage(f));
        } else if (f.name.endsWith('.plist')) {
          zipOut.file(newName, processPlist(await f.text()));
        } else {
          zipOut.file(newName, f);
        }
      }
    }
    st.innerText = "¡LISTO PARA DESCARGAR!";
    sv.style.display = "block";
    sv.onclick = async () => {
      const content = await zipOut.generateAsync({type:"blob"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(content);
      a.download = "GD_Fix_Pack.zip";
      a.click();
    };
  });
</script>
</body>
</html>
